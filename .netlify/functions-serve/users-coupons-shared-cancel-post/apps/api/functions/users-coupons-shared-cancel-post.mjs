
import {createRequire as ___nfyCreateRequire} from "module";
import {fileURLToPath as ___nfyFileURLToPath} from "url";
import {dirname as ___nfyPathDirname} from "path";
let __filename=___nfyFileURLToPath(import.meta.url);
let __dirname=___nfyPathDirname(___nfyFileURLToPath(import.meta.url));
let require=___nfyCreateRequire(import.meta.url);


// packages/shared/supabaseClient.ts
import { createClient } from "@supabase/supabase-js";
function readEnv(name) {
  try {
    if (typeof Netlify !== "undefined" && Netlify?.env?.get) {
      const v = Netlify.env.get(name);
      if (v)
        return v;
    }
  } catch {
  }
  return globalThis?.process?.env?.[name];
}
function createSupabaseClient(useServiceRole = false) {
  const url = readEnv("SUPABASE_URL");
  const anon = readEnv("SUPABASE_ANON_KEY");
  const service = readEnv("SUPABASE_SERVICE_ROLE_KEY");
  if (!url || !anon && !service) {
    throw new Error("Supabase env vars not set (SUPABASE_URL and key).");
  }
  const key = useServiceRole && service ? service : anon;
  return createClient(url, key, {
    auth: { persistSession: false }
  });
}

// apps/api/functions/users-coupons-shared-cancel-post.ts
var users_coupons_shared_cancel_post_default = async (req) => {
  if (req.method !== "POST")
    return new Response("Method Not Allowed", { status: 405 });
  const url = new URL(req.url);
  const parts = url.pathname.split("/");
  const userId = parts[3] || "";
  const shareId = parts[6] || "";
  if (!userId || !shareId)
    return new Response(JSON.stringify({ ok: false, error: "Invalid path" }), { status: 400 });
  const supabase = createSupabaseClient(true);
  const { data: share, error: shareErr } = await supabase.from("coupon_shares").select("id, original_user_coupon_id, sharer_user_id, receiver_user_id, shared_coupon_instance_id").eq("id", shareId).single();
  if (shareErr || !share)
    return new Response(JSON.stringify({ ok: false, error: "Share not found" }), { status: 404 });
  if (share.sharer_user_id !== userId)
    return new Response(JSON.stringify({ ok: false, error: "Not share owner" }), { status: 403 });
  const { data: sharedUC, error: ucErr } = await supabase.from("user_coupons").select("id, is_redeemed").eq("id", share.shared_coupon_instance_id).maybeSingle();
  if (ucErr)
    return new Response(JSON.stringify({ ok: false, error: ucErr.message }), { status: 500 });
  if (sharedUC && sharedUC.is_redeemed) {
    return new Response(JSON.stringify({ ok: false, error: "Already redeemed; cannot cancel" }), { status: 409 });
  }
  if (sharedUC) {
    const { error: delErr } = await supabase.from("user_coupons").delete().eq("id", share.shared_coupon_instance_id);
    if (delErr) {
    }
  }
  const { data: originalUC } = await supabase.from("user_coupons").select("transfer_count").eq("id", share.original_user_coupon_id).single();
  const newCount = Math.max(0, (originalUC?.transfer_count || 0) - 1);
  const { error: updErr } = await supabase.from("user_coupons").update({ current_owner_id: userId, transfer_count: newCount }).eq("id", share.original_user_coupon_id);
  if (updErr)
    return new Response(JSON.stringify({ ok: false, error: updErr.message }), { status: 500 });
  const { error: delShareErr } = await supabase.from("coupon_shares").delete().eq("id", shareId);
  if (delShareErr) {
  }
  return new Response(JSON.stringify({ ok: true }), { headers: { "Content-Type": "application/json" } });
};
var config = {
  path: "/api/users/:userId/coupons/shared/:shareId/cancel"
};
export {
  config,
  users_coupons_shared_cancel_post_default as default
};
//# sourceMappingURL=data:application/json;base64,ewogICJ2ZXJzaW9uIjogMywKICAic291cmNlcyI6IFsicGFja2FnZXMvc2hhcmVkL3N1cGFiYXNlQ2xpZW50LnRzIiwgImFwcHMvYXBpL2Z1bmN0aW9ucy91c2Vycy1jb3Vwb25zLXNoYXJlZC1jYW5jZWwtcG9zdC50cyJdLAogICJzb3VyY2VzQ29udGVudCI6IFsiLy8gU3VwYWJhc2UgY2xpZW50IGZhY3RvcnlcclxuLy8gUmVhZHMgZW52IGZyb20gTmV0bGlmeSAoTmV0bGlmeS5lbnYpIGlmIGF2YWlsYWJsZSwgb3RoZXJ3aXNlIHByb2Nlc3MuZW52XHJcblxyXG5pbXBvcnQgdHlwZSB7IFN1cGFiYXNlQ2xpZW50IGFzIFN1cGFiYXNlSnNDbGllbnQgfSBmcm9tICdAc3VwYWJhc2Uvc3VwYWJhc2UtanMnO1xyXG5pbXBvcnQgeyBjcmVhdGVDbGllbnQgfSBmcm9tICdAc3VwYWJhc2Uvc3VwYWJhc2UtanMnO1xyXG5cclxuZnVuY3Rpb24gcmVhZEVudihuYW1lOiBzdHJpbmcpOiBzdHJpbmcgfCB1bmRlZmluZWQge1xyXG4gIHRyeSB7XHJcbiAgICAvLyBAdHMtaWdub3JlIC0gTmV0bGlmeSBnbG9iYWwgbWF5IGV4aXN0IGF0IHJ1bnRpbWVcclxuICAgIGlmICh0eXBlb2YgTmV0bGlmeSAhPT0gJ3VuZGVmaW5lZCcgJiYgTmV0bGlmeT8uZW52Py5nZXQpIHtcclxuICAgICAgLy8gQHRzLWlnbm9yZVxyXG4gICAgICBjb25zdCB2ID0gTmV0bGlmeS5lbnYuZ2V0KG5hbWUpO1xyXG4gICAgICBpZiAodikgcmV0dXJuIHYgYXMgc3RyaW5nO1xyXG4gICAgfVxyXG4gIH0gY2F0Y2gge31cclxuICAvLyBGYWxsYmFja1xyXG4gIC8vIEB0cy1pZ25vcmVcclxuICByZXR1cm4gKGdsb2JhbFRoaXMgYXMgYW55KT8ucHJvY2Vzcz8uZW52Py5bbmFtZV0gYXMgc3RyaW5nIHwgdW5kZWZpbmVkO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlU3VwYWJhc2VDbGllbnQodXNlU2VydmljZVJvbGUgPSBmYWxzZSk6IFN1cGFiYXNlSnNDbGllbnQge1xyXG4gIGNvbnN0IHVybCA9IHJlYWRFbnYoJ1NVUEFCQVNFX1VSTCcpO1xyXG4gIGNvbnN0IGFub24gPSByZWFkRW52KCdTVVBBQkFTRV9BTk9OX0tFWScpO1xyXG4gIGNvbnN0IHNlcnZpY2UgPSByZWFkRW52KCdTVVBBQkFTRV9TRVJWSUNFX1JPTEVfS0VZJyk7XHJcbiAgaWYgKCF1cmwgfHwgKCFhbm9uICYmICFzZXJ2aWNlKSkge1xyXG4gICAgdGhyb3cgbmV3IEVycm9yKCdTdXBhYmFzZSBlbnYgdmFycyBub3Qgc2V0IChTVVBBQkFTRV9VUkwgYW5kIGtleSkuJyk7XHJcbiAgfVxyXG4gIGNvbnN0IGtleSA9IHVzZVNlcnZpY2VSb2xlICYmIHNlcnZpY2UgPyBzZXJ2aWNlIDogKGFub24gYXMgc3RyaW5nKTtcclxuICByZXR1cm4gY3JlYXRlQ2xpZW50KHVybCwga2V5LCB7XHJcbiAgICBhdXRoOiB7IHBlcnNpc3RTZXNzaW9uOiBmYWxzZSB9LFxyXG4gIH0pO1xyXG59XHJcbiIsICJpbXBvcnQgeyBjcmVhdGVTdXBhYmFzZUNsaWVudCB9IGZyb20gJy4uLy4uLy4uL3BhY2thZ2VzL3NoYXJlZC9zdXBhYmFzZUNsaWVudCc7XHJcblxyXG5leHBvcnQgZGVmYXVsdCBhc3luYyAocmVxOiBSZXF1ZXN0KSA9PiB7XHJcbiAgaWYgKHJlcS5tZXRob2QgIT09ICdQT1NUJykgcmV0dXJuIG5ldyBSZXNwb25zZSgnTWV0aG9kIE5vdCBBbGxvd2VkJywgeyBzdGF0dXM6IDQwNSB9KTtcclxuICBjb25zdCB1cmwgPSBuZXcgVVJMKHJlcS51cmwpO1xyXG4gIGNvbnN0IHBhcnRzID0gdXJsLnBhdGhuYW1lLnNwbGl0KCcvJyk7XHJcbiAgY29uc3QgdXNlcklkID0gcGFydHNbM10gfHwgJyc7XHJcbiAgY29uc3Qgc2hhcmVJZCA9IHBhcnRzWzZdIHx8ICcnO1xyXG4gIGlmICghdXNlcklkIHx8ICFzaGFyZUlkKSByZXR1cm4gbmV3IFJlc3BvbnNlKEpTT04uc3RyaW5naWZ5KHsgb2s6IGZhbHNlLCBlcnJvcjogJ0ludmFsaWQgcGF0aCcgfSksIHsgc3RhdHVzOiA0MDAgfSk7XHJcblxyXG4gIGNvbnN0IHN1cGFiYXNlID0gY3JlYXRlU3VwYWJhc2VDbGllbnQodHJ1ZSk7XHJcblxyXG4gIGNvbnN0IHsgZGF0YTogc2hhcmUsIGVycm9yOiBzaGFyZUVyciB9ID0gYXdhaXQgc3VwYWJhc2VcclxuICAgIC5mcm9tKCdjb3Vwb25fc2hhcmVzJylcclxuICAgIC5zZWxlY3QoJ2lkLCBvcmlnaW5hbF91c2VyX2NvdXBvbl9pZCwgc2hhcmVyX3VzZXJfaWQsIHJlY2VpdmVyX3VzZXJfaWQsIHNoYXJlZF9jb3Vwb25faW5zdGFuY2VfaWQnKVxyXG4gICAgLmVxKCdpZCcsIHNoYXJlSWQpXHJcbiAgICAuc2luZ2xlKCk7XHJcbiAgaWYgKHNoYXJlRXJyIHx8ICFzaGFyZSkgcmV0dXJuIG5ldyBSZXNwb25zZShKU09OLnN0cmluZ2lmeSh7IG9rOiBmYWxzZSwgZXJyb3I6ICdTaGFyZSBub3QgZm91bmQnIH0pLCB7IHN0YXR1czogNDA0IH0pO1xyXG4gIGlmIChzaGFyZS5zaGFyZXJfdXNlcl9pZCAhPT0gdXNlcklkKVxyXG4gICAgcmV0dXJuIG5ldyBSZXNwb25zZShKU09OLnN0cmluZ2lmeSh7IG9rOiBmYWxzZSwgZXJyb3I6ICdOb3Qgc2hhcmUgb3duZXInIH0pLCB7IHN0YXR1czogNDAzIH0pO1xyXG5cclxuICBjb25zdCB7IGRhdGE6IHNoYXJlZFVDLCBlcnJvcjogdWNFcnIgfSA9IGF3YWl0IHN1cGFiYXNlXHJcbiAgICAuZnJvbSgndXNlcl9jb3Vwb25zJylcclxuICAgIC5zZWxlY3QoJ2lkLCBpc19yZWRlZW1lZCcpXHJcbiAgICAuZXEoJ2lkJywgc2hhcmUuc2hhcmVkX2NvdXBvbl9pbnN0YW5jZV9pZClcclxuICAgIC5tYXliZVNpbmdsZSgpO1xyXG4gIGlmICh1Y0VycikgcmV0dXJuIG5ldyBSZXNwb25zZShKU09OLnN0cmluZ2lmeSh7IG9rOiBmYWxzZSwgZXJyb3I6IHVjRXJyLm1lc3NhZ2UgfSksIHsgc3RhdHVzOiA1MDAgfSk7XHJcbiAgaWYgKHNoYXJlZFVDICYmIHNoYXJlZFVDLmlzX3JlZGVlbWVkKSB7XHJcbiAgICByZXR1cm4gbmV3IFJlc3BvbnNlKEpTT04uc3RyaW5naWZ5KHsgb2s6IGZhbHNlLCBlcnJvcjogJ0FscmVhZHkgcmVkZWVtZWQ7IGNhbm5vdCBjYW5jZWwnIH0pLCB7IHN0YXR1czogNDA5IH0pO1xyXG4gIH1cclxuXHJcbiAgaWYgKHNoYXJlZFVDKSB7XHJcbiAgICBjb25zdCB7IGVycm9yOiBkZWxFcnIgfSA9IGF3YWl0IHN1cGFiYXNlXHJcbiAgICAgIC5mcm9tKCd1c2VyX2NvdXBvbnMnKVxyXG4gICAgICAuZGVsZXRlKClcclxuICAgICAgLmVxKCdpZCcsIHNoYXJlLnNoYXJlZF9jb3Vwb25faW5zdGFuY2VfaWQpO1xyXG4gICAgLy8gSWYgZGVsZXRpb24gZmFpbHMgZHVlIHRvIFJMUyBvciBwcmlvciB0cmFuc2ZlciwgY29udGludWUgcm9sbGJhY2sgdG8gcmVzdG9yZSBvd25lcnNoaXBcclxuICAgIGlmIChkZWxFcnIpIHtcclxuICAgICAgLy8gcHJvY2VlZCB3aXRob3V0IGhhcmQgZmFpbGluZ1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgY29uc3QgeyBkYXRhOiBvcmlnaW5hbFVDIH0gPSBhd2FpdCBzdXBhYmFzZVxyXG4gICAgLmZyb20oJ3VzZXJfY291cG9ucycpXHJcbiAgICAuc2VsZWN0KCd0cmFuc2Zlcl9jb3VudCcpXHJcbiAgICAuZXEoJ2lkJywgc2hhcmUub3JpZ2luYWxfdXNlcl9jb3Vwb25faWQpXHJcbiAgICAuc2luZ2xlKCk7XHJcbiAgY29uc3QgbmV3Q291bnQgPSBNYXRoLm1heCgwLCAob3JpZ2luYWxVQz8udHJhbnNmZXJfY291bnQgfHwgMCkgLSAxKTtcclxuICBjb25zdCB7IGVycm9yOiB1cGRFcnIgfSA9IGF3YWl0IHN1cGFiYXNlXHJcbiAgICAuZnJvbSgndXNlcl9jb3Vwb25zJylcclxuICAgIC51cGRhdGUoeyBjdXJyZW50X293bmVyX2lkOiB1c2VySWQsIHRyYW5zZmVyX2NvdW50OiBuZXdDb3VudCB9KVxyXG4gICAgLmVxKCdpZCcsIHNoYXJlLm9yaWdpbmFsX3VzZXJfY291cG9uX2lkKTtcclxuICBpZiAodXBkRXJyKSByZXR1cm4gbmV3IFJlc3BvbnNlKEpTT04uc3RyaW5naWZ5KHsgb2s6IGZhbHNlLCBlcnJvcjogdXBkRXJyLm1lc3NhZ2UgfSksIHsgc3RhdHVzOiA1MDAgfSk7XHJcblxyXG4gIGNvbnN0IHsgZXJyb3I6IGRlbFNoYXJlRXJyIH0gPSBhd2FpdCBzdXBhYmFzZS5mcm9tKCdjb3Vwb25fc2hhcmVzJykuZGVsZXRlKCkuZXEoJ2lkJywgc2hhcmVJZCk7XHJcbiAgaWYgKGRlbFNoYXJlRXJyKSB7XHJcbiAgICAvLyBJZiBzaGFyZSByb3cgYWxyZWFkeSBnb25lLCBzdGlsbCBjb25zaWRlciBzdWNjZXNzIGFmdGVyIHJlc3RvcmluZyBvd25lcnNoaXBcclxuICB9XHJcblxyXG4gIHJldHVybiBuZXcgUmVzcG9uc2UoSlNPTi5zdHJpbmdpZnkoeyBvazogdHJ1ZSB9KSwgeyBoZWFkZXJzOiB7ICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicgfSB9KTtcclxufTtcclxuXHJcbmV4cG9ydCBjb25zdCBjb25maWcgPSB7XHJcbiAgcGF0aDogJy9hcGkvdXNlcnMvOnVzZXJJZC9jb3Vwb25zL3NoYXJlZC86c2hhcmVJZC9jYW5jZWwnLFxyXG59O1xyXG4iXSwKICAibWFwcGluZ3MiOiAiOzs7Ozs7Ozs7O0FBSUEsU0FBUyxvQkFBb0I7QUFFN0IsU0FBUyxRQUFRLE1BQWtDO0FBQ2pELE1BQUk7QUFFRixRQUFJLE9BQU8sWUFBWSxlQUFlLFNBQVMsS0FBSyxLQUFLO0FBRXZELFlBQU0sSUFBSSxRQUFRLElBQUksSUFBSSxJQUFJO0FBQzlCLFVBQUk7QUFBRyxlQUFPO0FBQUEsSUFDaEI7QUFBQSxFQUNGLFFBQVE7QUFBQSxFQUFDO0FBR1QsU0FBUSxZQUFvQixTQUFT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
