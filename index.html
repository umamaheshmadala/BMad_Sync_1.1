<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SynC MVP – Dev Console</title>
    <style>
      :root { color-scheme: light dark; }
      body { font-family: system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 24px; line-height: 1.4; }
      header { margin-bottom: 16px; }
      button { padding: 8px 12px; margin-right: 8px; }
      pre { background: rgba(128,128,128,0.15); padding: 12px; border-radius: 8px; overflow: auto; }
      .row { margin: 12px 0; }
      input[type="text"] { padding: 6px 8px; min-width: 280px; }
      small { opacity: 0.7; }
    </style>
  </head>
  <body>
    <header>
      <h2>SynC MVP – Local Dev Console</h2>
      <small>Netlify dev at <code>http://localhost:8888</code>. Use this page to hit API endpoints quickly.</small>
    </header>

    <section class="row">
      <button id="btnCfg">GET /api/platform/config</button>
      <button id="btnRevenue">GET /api/platform/revenue</button>
    </section>

    <section class="row">
      <button id="btnSeed">POST /api/tests/seed</button>
      <small>(Seeds users, business, and a coupon. If env not injected, retries with body override.)</small>
    </section>

    <section class="row">
      <label>PUT /api/platform/config/runtime – key:value</label><br />
      <input id="keyInput" type="text" value="ads.carousel_slots" />
      <input id="valInput" type="text" value="5" />
      <button id="btnPutCfg">PUT</button>
    </section>

    <section class="row">
      <label>GET /api/business/storefront (Bearer sub=owner)</label>
      <button id="btnStoreGet">GET</button>
      <button id="btnStorePost">POST upsert</button>
    </section>

    <pre id="out">Ready.</pre>

    <script>
      const out = document.getElementById('out');
      const base = location.origin;
      let seededBiz = '';

      function setOut(obj) {
        out.textContent = typeof obj === 'string' ? obj : JSON.stringify(obj, null, 2);
      }

      function bearer(sub, role) {
        const header = btoa(JSON.stringify({ alg: 'none', typ: 'JWT' }));
        const payload = btoa(JSON.stringify(role ? { sub, role } : { sub }));
        return `Bearer ${header}.${payload}.`;
      }

      document.getElementById('btnCfg').onclick = async () => {
        const r = await fetch(`${base}/api/platform/config`);
        setOut(await r.json());
      };

      document.getElementById('btnRevenue').onclick = async () => {
        const r = await fetch(`${base}/api/platform/revenue`);
        setOut(await r.json());
      };

      document.getElementById('btnSeed').onclick = async () => {
        // Try simple POST first
        let r = await fetch(`${base}/api/tests/seed`, { method: 'POST', headers: { 'Content-Type': 'application/json' } });
        if (!r.ok) {
          // Retry with body override if needed
          const body = { supabase_url: window.SUPABASE_URL || '', service_key: window.SUPABASE_SERVICE_ROLE_KEY || '' };
          r = await fetch(`${base}/api/tests/seed`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
        }
        const js = await r.json();
        if (js && js.business_id) seededBiz = js.business_id;
        setOut(js);
      };

      document.getElementById('btnPutCfg').onclick = async () => {
        const key = document.getElementById('keyInput').value.trim();
        const val = document.getElementById('valInput').value.trim();
        const body = { [key]: { value: isNaN(Number(val)) ? val : Number(val) } };
        const r = await fetch(`${base}/api/platform/config/runtime`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
        setOut(await r.json());
      };

      document.getElementById('btnStoreGet').onclick = async () => {
        const headers = { Authorization: bearer('11111111-1111-1111-1111-111111111111', 'owner') };
        if (seededBiz) headers['x-business-id'] = seededBiz;
        const r = await fetch(`${base}/api/business/storefront`, { headers });
        setOut(await r.json());
      };

      document.getElementById('btnStorePost').onclick = async () => {
        const headers = { 'Content-Type': 'application/json', Authorization: bearer('11111111-1111-1111-1111-111111111111', 'owner') };
        if (seededBiz) headers['x-business-id'] = seededBiz;
        const body = { description: 'Great store', theme: 'light', is_open: true };
        const r = await fetch(`${base}/api/business/storefront`, { method: 'POST', headers, body: JSON.stringify(body) });
        setOut(await r.json());
      };
    </script>
  </body>
  </html>


